### 高级光照

* Blinn-Phong光照模型

  * 计算半程向量与镜面法向量的点积
  * 避免了Phong的反射方向与视线方向的角度过大点积结果为0


---
### 伽马校正

* 在线性空间中PBR，将最终结果校正到sRGB
* 计算混合、缩放、反走样时都需要伽马校正
* sRGB材质图片需要转换到线性空间中


* 真实光线衰减 = 1 / 距离<sup>2</sup>
  * 模拟：\[计算]-> 1/d ->\[sRGB<sup>2.2</sup>]-> 1/d<sup>2.2</sup>
  * 伽马校正：\[物理计算]-> 1/d<sup>2</sup> ->\[Gammma<sup>1/2.2</sup>]-> 1/d ->\[sRGB<sup>2.2</sup>]-> 1/d<sup>2.2</sup>


---
### 阴影映射


* 光源空间坐标转换后将深度格式的纹理贴图绑定到帧缓冲，渲染得到阴影贴图。
* 将光空间中的片段位置映射到阴影贴图中，比较记录深度和实际深度。


---
### 点阴影

* 使用`GL_TEXTURE_CUBE_MAP`深度贴图

  * 在几何着色器中`gl_Layer`激活的每个面上绘制对应空间变换后的点
  
    * 投影矩阵对每个面都是一样的
    * 视图矩阵依次对右、左、上、下、近、远计算
  * 在片段着色器中写入规范化的`gl_FragDepth`


---
### 法线贴图

* RGB格式的法线贴图需要从\[0\~1]映射至\[-1\~1]

* 在顶点着色器中计算切线空间的位置 ，由片段着色器进行常规着色。

* 由顶点着色器计算切线矩阵，传递给片段着色器计算世界空间的位置。<br>
  `片段着色器运行次数远多于顶点着色器次数，矩阵计算次数更多。`
  
* 由施密特正交化调整平均化的切线向量<br>
  `T = T - T在N上的投影cos(T,N)·N`


---
### 视差贴图


* 对变化陡峭的高度划分多个深度层进行采样

  `随着层数增加，偏移量也在增加，当深度层值超过采样深度时停止。`

* 对深度值交替的两层的作纹理坐标的插值实现视差遮蔽映射

  `深度贴图采样值和深度层值的差作为插值`


---
### HDR


* 曝光色调映射：LDR = 1 - e<sup>-HDR·exposure</sup> 


---
### 泛光

> Offscreen Frame Buffer
>> Texture Color Attachment 0:   LDR Scene<br>
>> Texture Color Attachment 1:   HDR Bloom<br>
>> Render Buffer Attachment

* 由两个FBO绑定纹理附件实现两步高斯模糊<br>
  * 每次在一个FBO中对另一个FBO的纹理附件采样
  * 初始化时对泛光纹理(HDR Bloom)采样

* 对LDR Scene和Bloom模糊结果混合，再作色调映射实现。


---
### 延迟着色法


* 在G缓冲下计算位置、法线、颜色、反射，并包含深度测试。<br>
  在默认帧缓冲中绘制方形，每一个片段只进行一次光照计算。
  
* `glDrawBuffer(3, buffers)` 声明片段着色器结果绘制到3个纹理附件中

* `glBlitFramebuffer`将G缓冲的颜色或深度信息复制到默认帧缓冲进行正向渲染
